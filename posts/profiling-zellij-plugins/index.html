<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Learnings from developing a zellij plugin | blog.nerd.rocks</title><meta name=keywords content="zellij,rust,tdd,benchmarks"><meta name=description content="Zellij is a terminal multiplexer written in Rust, that aims to provide an intuitive and easy to extend working environment. With version 0.37.0 Zellij introduced a plugin system, that allows users to write plugins with WebAssembly. Additionally the plugin system provides a rust crate with an API to interact with the Zellij core.
Since zellij to the date of writing this article has not provided customizations for the status bar, I decided to write one that is easily customizable by writing KDL configuration into layout files - zjstatus."><meta name=author content><link rel=canonical href=https://blog.nerd.rocks/posts/profiling-zellij-plugins/><link crossorigin=anonymous href=/assets/css/stylesheet.706230b2c01b2f9cec39f070771415c37f76ed4d690dae0d9f25fa66dfb55d9e.css integrity="sha256-cGIwssAbL5zsOfBwdxQVw3927U1pDa4NnyX6Zt+1XZ4=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.nerd.rocks/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nerd.rocks/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nerd.rocks/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nerd.rocks/apple-touch-icon.png><link rel=mask-icon href=https://blog.nerd.rocks/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Learnings from developing a zellij plugin"><meta property="og:description" content="Zellij is a terminal multiplexer written in Rust, that aims to provide an intuitive and easy to extend working environment. With version 0.37.0 Zellij introduced a plugin system, that allows users to write plugins with WebAssembly. Additionally the plugin system provides a rust crate with an API to interact with the Zellij core.
Since zellij to the date of writing this article has not provided customizations for the status bar, I decided to write one that is easily customizable by writing KDL configuration into layout files - zjstatus."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.nerd.rocks/posts/profiling-zellij-plugins/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-01T12:05:02+02:00"><meta property="article:modified_time" content="2024-01-01T12:05:02+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Learnings from developing a zellij plugin"><meta name=twitter:description content="Zellij is a terminal multiplexer written in Rust, that aims to provide an intuitive and easy to extend working environment. With version 0.37.0 Zellij introduced a plugin system, that allows users to write plugins with WebAssembly. Additionally the plugin system provides a rust crate with an API to interact with the Zellij core.
Since zellij to the date of writing this article has not provided customizations for the status bar, I decided to write one that is easily customizable by writing KDL configuration into layout files - zjstatus."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.nerd.rocks/posts/"},{"@type":"ListItem","position":2,"name":"Learnings from developing a zellij plugin","item":"https://blog.nerd.rocks/posts/profiling-zellij-plugins/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Learnings from developing a zellij plugin","name":"Learnings from developing a zellij plugin","description":"Zellij is a terminal multiplexer written in Rust, that aims to provide an intuitive and easy to extend working environment. With version 0.37.0 Zellij introduced a plugin system, that allows users to write plugins with WebAssembly. Additionally the plugin system provides a rust crate with an API to interact with the Zellij core.\nSince zellij to the date of writing this article has not provided customizations for the status bar, I decided to write one that is easily customizable by writing KDL configuration into layout files - zjstatus.","keywords":["zellij","rust","tdd","benchmarks"],"articleBody":"Zellij is a terminal multiplexer written in Rust, that aims to provide an intuitive and easy to extend working environment. With version 0.37.0 Zellij introduced a plugin system, that allows users to write plugins with WebAssembly. Additionally the plugin system provides a rust crate with an API to interact with the Zellij core.\nSince zellij to the date of writing this article has not provided customizations for the status bar, I decided to write one that is easily customizable by writing KDL configuration into layout files - zjstatus.\nWhile writing, extending and refactoring the plugin, I learned a lot about the plugin system, WebAssembly and Rust in general. Especially about performance impact in Rust when memory management is not implemented correctly. In this article I want to share some of these insights.\nIn order to follow the article, please check out the official rust-plugin-example, which I used as a starting point.\nInitial setup This section describes some actions I took to set up the development environment for simplifying the development process.\nDevelopment dependencies Since Iâ€™m a big fan of nix and nixOS, I started by creating a shell.nix file, that provides all the dependencies needed for development. It contains a pinned version of the nixpkgs repository, that holds build instructions for used dependencies and their respective versions.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 { pkgs ? import {} }: with pkgs; let pinnedPkgs = fetchFromGitHub { owner = \"NixOS\"; repo = \"nixpkgs\"; rev = \"a63a64b593dcf2fe05f7c5d666eb395950f36bc9\"; sha256 = \"sha256-+ZoAny3ZxLcfMaUoLVgL9Ywb/57wP+EtsdNGuXUJrwg=\"; }; pkgs = import pinnedPkgs {}; inherit (lib) optional optionals; inherit (darwin.apple_sdk.frameworks) Cocoa CoreGraphics Foundation IOKit Kernel OpenGL Security; in pkgs.mkShell rec { buildInputs = with pkgs; [ clang # Replace llvmPackages with llvmPackages_X, where X is the latest LLVM version (at the time of writing, 16) llvmPackages.bintools rustup libiconv watchexec ]; RUSTC_VERSION = pkgs.lib.readFile ./rust-toolchain; # https://github.com/rust-lang/rust-bindgen#environment-variables LIBCLANG_PATH = pkgs.lib.makeLibraryPath [ pkgs.llvmPackages_latest.libclang.lib ]; shellHook = '' export PATH=$PATH:''${CARGO_HOME:-~/.cargo}/bin export PATH=$PATH:''${RUSTUP_HOME:-~/.rustup}/toolchains/$RUSTC_VERSION-x86_64-unknown-linux-gnu/bin/ ''; # Add precompiled library to rustc search path RUSTFLAGS = (builtins.map (a: ''-L ${a}/lib'') [ # add libraries here (e.g. pkgs.libvmi) ]); # Add glibc, clang, glib and other headers to bindgen search path BINDGEN_EXTRA_CLANG_ARGS = # Includes with normal include path (builtins.map (a: ''-I\"${a}/include\"'') [ # add dev libraries here (e.g. pkgs.libvmi.dev) pkgs.libiconv ]) # Includes with special directory paths ++ [ ''-I\"${pkgs.llvmPackages_latest.libclang.lib}/lib/clang/${pkgs.llvmPackages_latest.libclang.version}/include\"'' ''-I\"${pkgs.libiconv.out}/lib/\"'' ]; } It will install clang, llvm, rustup, libiconv and watchexec into a nix shell, additionally to configure build dependencies for the rust compiler. To automatically enable usage of these dependencies, I added a .envrc to utilze direnv for automatically loading the nix shell when entering the project directory.\n1 use nix Later on I switched to a flake.nix file to provide a convenient, reproducible and declarative way to build the project.\nTask runner Even if most of the tasks while developing can be done by directly running cargo commands, I start by setting up a justfile, that is used by just, an alternative to make. Then justfile will provide a unified interface to run all the commands needed for development and also lists them conveniently.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 build: cargo build run: build zellij -l ./plugin-dev-workspace.kdl -s zjstatus-dev test: cargo component test -- --nocapture lint: cargo clippy --all-targets -- -D warnings cargo audit release version: cargo set-version {{version}} direnv exec . cargo build --release git commit -am \"chore: bump version to v{{version}}\" git tag -m \"v{{version}}\" v{{version}} git cliff --current Commands can be run by calling just , e.g. just run. The syntax for releases allows to bump the version and create a git tag with a single command: just release 0.1.0.\nSplitting code to binary and library As we want to write tests and benchmarks for the code, we need to split the entrypoint of the plugin from the library code. All parts that we want to test and benchmark need to be part of the library crate. To split the binary from the library, we need to modify the file structure in the following way:\n1 2 src/main.rs -\u003e src/bin/plugin-name.rs # move src/lib.rs # create The current main file will be moved to src/bin/plugin.rs and the src/lib.rs file will be created. src/lib.rs will contain the library code, that contains logic for the plugin. In addition to the directory structure, we need to modify the Cargo.toml file to reflect the changes:\n1 2 3 4 5 6 [[bin]] name = \"plugin-name\" bench = false [lib] bench = false This will prevent cargo from directly running library or binary code, when only benchmarks should be run. It is important to configure the project like that because zellijâ€™s API with register_plugin will try to connect to the running zellij instance, which is not present when running benchmarks. Since all logic related code is now located in the library, we need to import it in the binary or benchmarks with use plugin_name::*;.\nUnit testing For ensuring the correctness of plugin logic and to validate, that the logic works as expected when refactoring the code, I am a big fan of unit testing. It not only helps to ensure correctness, but also provides a way to document the code and its usage. In addition it helps to develop new features in a test driven way, such that the test is written before the actual implementation.\nUnit tests in zellij plugins can be written by adding a #[cfg(test)] attribute to the test module and writing tests with the #[test] attribute - like in any other rust project. You just need to make sure, that code that interacts with zellijâ€™s API is not executed when running tests, as it will fail otherwise. This can be done by using the #[cfg(not(test))] attribute on the code that should not be executed when running tests.\nAnother tricky part is to run the unit tests, as they need to be run within a WebAssembly runtime (like wasmtime). To simplify running the tests, I added cargo-component to the project dependencies, which runs code with wasmtime after it has been compiled. A shortcut for running the tests was also added to the justfile before.\nHereâ€™s an example of a unit test, that verifies the correctness of the parse_color function:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #[cfg(test)] mod test { use super::*; #[test] fn test_parse_color() { let result = parse_color(\"#010203\"); let expected = RgbColor(1, 2, 3); assert_eq!(result, Some(expected.into())); let result = parse_color(\"255\"); let expected = Ansi256Color(255); assert_eq!(result, Some(expected.into())); let result = parse_color(\"365\"); assert_eq!(result, None); let result = parse_color(\"#365\"); assert_eq!(result, None); } } Benchmarks Benchmarks can be used to check for performance regressions when refactoring code. They can also be used to measure the performance impact of new features. Therefore it is important to store results of the benchmarks, to compare them with future runs.\nNormally, I like to use divan for writing benchmarks, but it does not support WebAssembly yet. Therefore I switched to criterion since it supports WebAssembly and provides some convenient features for storing and comparing benchmark results.\nTo start with benchmarks, first add criterion and the benchmark targets to the Cargo.toml file:\n1 2 3 4 5 6 [dev-dependencies] criterion = { version = \"0.5.1\", default-features = false, features = [\"html_reports\"] } [[bench]] name = \"benches\" harness = false Benchmark targets must be named like the benchmark files in the benches directory, e.g. benches/benches.rs.\nFollow the criterion documentation for writing benchmarks. Hereâ€™s a quick example:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 use criterion::{criterion_group, criterion_main, Criterion}; use zjstatus::render::formatted_parts_from_string_cached; fn bench_formattedparts_from_format_string_cached(c: \u0026mut Criterion) { c.bench_function(\"formatted_parts_from_string_cached\", |b| { b.iter(|| { formatted_parts_from_string_cached( \"#[fg=#9399B2,bg=#181825,bold,italic] {index} {name} [] #[fg=#9399B2,bg=#181825,bold,italic] {index} {name} [] \", ) }) }); } fn criterion_benchmark(c: \u0026mut Criterion) { bench_formattedparts_from_format_string_cached(c); } criterion_group!(benches, criterion_benchmark); criterion_main!(benches); Similar to unit tests we need to make sure that code which interacts with zellijâ€™s API is not executed when running benchmarks. Therefore we need to add a new feature to the Cargo.toml and add the #[cfg(not(feature = \"bench\"))] attribute to the code that should not be executed when running benchmarks.\n1 2 [features] bench = [] Since criterion needs to store benchmark results in the target directory, we cannot run benchmarks with cargo component bench. cargo component bench will not only try to run the plugin wasm binary outside of zellij, but also runs the benchmarks in wasmtime without granting permissions to write to the target directory. Therefore we need to compile benchmarks with cargo bench --target wasm32-wasi --benches --no-run --feature=benches. After compilation it will print the path to the compiled binaries. These binaries then must be executed with wasmtime and the --dir flag to grant permissions to write to the target directory. The following target in the justfile will automate this process:\n1 2 3 4 5 6 bench: #!/usr/bin/env bash benchmarks=\"$(cargo bench --target wasm32-wasi --features=bench --no-run --color=always 2\u003e\u00261 | tee /dev/tty | grep -oP 'target/.*.wasm')\" echo \"$benchmarks\" \\ | xargs -I{} wasmtime --dir $PWD/target::target {} --bench --color=always Since the benchmarks are now able to store the json results in the target directory, criterion is able to compare the result with previous runs.\nThis technique allowed me to improve the performance of zjstatus a lot, after I learned how to better utilize the borrow checker and be aware of memory allocations. To improve performance, I tried to avoid .clone() calls where possible and instead use references, since references are cheap to copy, whereas .clone() needs to allocate memory of the size of the cloned object and copy the data.\n","wordCount":"1648","inLanguage":"en","datePublished":"2024-01-01T12:05:02+02:00","dateModified":"2024-01-01T12:05:02+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nerd.rocks/posts/profiling-zellij-plugins/"},"publisher":{"@type":"Organization","name":"blog.nerd.rocks","logo":{"@type":"ImageObject","url":"https://blog.nerd.rocks/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nerd.rocks accesskey=h title="blog.nerd.rocks (Alt + H)">blog.nerd.rocks</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://blog.nerd.rocks/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://blog.nerd.rocks/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.nerd.rocks/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Learnings from developing a zellij plugin</h1><div class=post-meta><span title='2024-01-01 12:05:02 +0200 +0200'>2024-01-01</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#initial-setup aria-label="Initial setup">Initial setup</a><ul><li><a href=#development-dependencies aria-label="Development dependencies">Development dependencies</a></li><li><a href=#task-runner aria-label="Task runner">Task runner</a></li><li><a href=#splitting-code-to-binary-and-library aria-label="Splitting code to binary and library">Splitting code to binary and library</a></li></ul></li><li><a href=#unit-testing aria-label="Unit testing">Unit testing</a></li><li><a href=#benchmarks aria-label=Benchmarks>Benchmarks</a></li></ul></div></details></div><div class=post-content><p>Zellij is a terminal multiplexer written in Rust, that aims to provide an intuitive and easy to extend working environment.
With version 0.37.0 Zellij introduced a plugin system, that allows users to write plugins with WebAssembly.
Additionally the plugin system provides a rust crate with an API to interact with the Zellij core.</p><p>Since zellij to the date of writing this article has not provided customizations for the status bar, I decided to write one that is easily customizable by writing KDL configuration into layout files - <a href=https://github.com/dj95/zjstatus>zjstatus</a>.</p><p>While writing, extending and refactoring the plugin, I learned a lot about the plugin system, WebAssembly and Rust in general.
Especially about performance impact in Rust when memory management is not implemented correctly.
In this article I want to share some of these insights.</p><p>In order to follow the article, please check out the official <a href=https://github.com/zellij-org/rust-plugin-example>rust-plugin-example</a>, which I used as a starting point.</p><h2 id=initial-setup>Initial setup<a hidden class=anchor aria-hidden=true href=#initial-setup>#</a></h2><p>This section describes some actions I took to set up the development environment for simplifying the development process.</p><h3 id=development-dependencies>Development dependencies<a hidden class=anchor aria-hidden=true href=#development-dependencies>#</a></h3><p>Since I&rsquo;m a big fan of nix and nixOS, I started by creating a <code>shell.nix</code> file, that provides all the dependencies needed for development.
It contains a pinned version of the nixpkgs repository, that holds build instructions for used dependencies and their respective versions.</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs <span style=color:#89dceb;font-weight:700>?</span> <span style=color:#94e2d5>import</span> <span style=color:#94e2d5>&lt;nixpkgs&gt;</span> {} }:
</span></span><span style=display:flex><span><span style=color:#cba6f7>with</span> pkgs;
</span></span><span style=display:flex><span><span style=color:#cba6f7>let</span>
</span></span><span style=display:flex><span>  pinnedPkgs <span style=color:#89dceb;font-weight:700>=</span> fetchFromGitHub {
</span></span><span style=display:flex><span>    owner <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;NixOS&#34;</span>;
</span></span><span style=display:flex><span>    repo <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;nixpkgs&#34;</span>;
</span></span><span style=display:flex><span>    rev <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;a63a64b593dcf2fe05f7c5d666eb395950f36bc9&#34;</span>;
</span></span><span style=display:flex><span>    sha256 <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;sha256-+ZoAny3ZxLcfMaUoLVgL9Ywb/57wP+EtsdNGuXUJrwg=&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  pkgs <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#94e2d5>import</span> pinnedPkgs {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>inherit</span> (lib) optional optionals;
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>inherit</span> (darwin<span style=color:#89dceb;font-weight:700>.</span>apple_sdk<span style=color:#89dceb;font-weight:700>.</span>frameworks) Cocoa CoreGraphics Foundation IOKit Kernel OpenGL Security;
</span></span><span style=display:flex><span><span style=color:#cba6f7>in</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#89dceb;font-weight:700>.</span>mkShell <span style=color:#cba6f7>rec</span> {
</span></span><span style=display:flex><span>    buildInputs <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#cba6f7>with</span> pkgs; [
</span></span><span style=display:flex><span>      clang
</span></span><span style=display:flex><span>      <span style=color:#6c7086;font-style:italic># Replace llvmPackages with llvmPackages_X, where X is the latest LLVM version (at the time of writing, 16)</span>
</span></span><span style=display:flex><span>      llvmPackages<span style=color:#89dceb;font-weight:700>.</span>bintools
</span></span><span style=display:flex><span>      rustup
</span></span><span style=display:flex><span>      libiconv
</span></span><span style=display:flex><span>      watchexec
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>    RUSTC_VERSION <span style=color:#89dceb;font-weight:700>=</span> pkgs<span style=color:#89dceb;font-weight:700>.</span>lib<span style=color:#89dceb;font-weight:700>.</span>readFile <span style=color:#94e2d5>./rust-toolchain</span>;
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic># https://github.com/rust-lang/rust-bindgen#environment-variables</span>
</span></span><span style=display:flex><span>    LIBCLANG_PATH <span style=color:#89dceb;font-weight:700>=</span> pkgs<span style=color:#89dceb;font-weight:700>.</span>lib<span style=color:#89dceb;font-weight:700>.</span>makeLibraryPath [ pkgs<span style=color:#89dceb;font-weight:700>.</span>llvmPackages_latest<span style=color:#89dceb;font-weight:700>.</span>libclang<span style=color:#89dceb;font-weight:700>.</span>lib ];
</span></span><span style=display:flex><span>    shellHook <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e3a1>      export PATH=$PATH:</span><span style=color:#89b4fa>&#39;&#39;$</span><span style=color:#a6e3a1>{CARGO_HOME:-~/.cargo}/bin
</span></span></span><span style=display:flex><span><span style=color:#a6e3a1>      export PATH=$PATH:</span><span style=color:#89b4fa>&#39;&#39;$</span><span style=color:#a6e3a1>{RUSTUP_HOME:-~/.rustup}/toolchains/$RUSTC_VERSION-x86_64-unknown-linux-gnu/bin/
</span></span></span><span style=display:flex><span><span style=color:#a6e3a1>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic># Add precompiled library to rustc search path</span>
</span></span><span style=display:flex><span>    RUSTFLAGS <span style=color:#89dceb;font-weight:700>=</span> (<span style=color:#89dceb>builtins</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#89dceb>map</span> (a: <span style=color:#a6e3a1>&#39;&#39;-L </span><span style=color:#a6e3a1>${</span>a<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>/lib&#39;&#39;</span>) [
</span></span><span style=display:flex><span>      <span style=color:#6c7086;font-style:italic># add libraries here (e.g. pkgs.libvmi)</span>
</span></span><span style=display:flex><span>    ]);
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic># Add glibc, clang, glib and other headers to bindgen search path</span>
</span></span><span style=display:flex><span>    BINDGEN_EXTRA_CLANG_ARGS <span style=color:#89dceb;font-weight:700>=</span> 
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic># Includes with normal include path</span>
</span></span><span style=display:flex><span>    (<span style=color:#89dceb>builtins</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#89dceb>map</span> (a: <span style=color:#a6e3a1>&#39;&#39;-I&#34;</span><span style=color:#a6e3a1>${</span>a<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>/include&#34;&#39;&#39;</span>) [
</span></span><span style=display:flex><span>      <span style=color:#6c7086;font-style:italic># add dev libraries here (e.g. pkgs.libvmi.dev)</span>
</span></span><span style=display:flex><span>      pkgs<span style=color:#89dceb;font-weight:700>.</span>libiconv
</span></span><span style=display:flex><span>    ])
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic># Includes with special directory paths</span>
</span></span><span style=display:flex><span>    <span style=color:#89dceb;font-weight:700>++</span> [
</span></span><span style=display:flex><span>      <span style=color:#a6e3a1>&#39;&#39;-I&#34;</span><span style=color:#a6e3a1>${</span>pkgs<span style=color:#89dceb;font-weight:700>.</span>llvmPackages_latest<span style=color:#89dceb;font-weight:700>.</span>libclang<span style=color:#89dceb;font-weight:700>.</span>lib<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>/lib/clang/</span><span style=color:#a6e3a1>${</span>pkgs<span style=color:#89dceb;font-weight:700>.</span>llvmPackages_latest<span style=color:#89dceb;font-weight:700>.</span>libclang<span style=color:#89dceb;font-weight:700>.</span>version<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>/include&#34;&#39;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e3a1>&#39;&#39;-I&#34;</span><span style=color:#a6e3a1>${</span>pkgs<span style=color:#89dceb;font-weight:700>.</span>libiconv<span style=color:#89dceb;font-weight:700>.</span>out<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>/lib/&#34;&#39;&#39;</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></td></tr></table></div></div><p>It will install <code>clang</code>, <code>llvm</code>, <code>rustup</code>, <code>libiconv</code> and <code>watchexec</code> into a nix shell, additionally to configure build dependencies for the rust compiler.
To automatically enable usage of these dependencies, I added a <code>.envrc</code> to utilze <a href=https://direnv.net>direnv</a> for automatically loading the nix shell when entering the project directory.</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>use nix
</span></span></code></pre></td></tr></table></div></div><p>Later on I switched to a <code>flake.nix</code> file to provide a convenient, reproducible and declarative way to build the project.</p><h3 id=task-runner>Task runner<a hidden class=anchor aria-hidden=true href=#task-runner>#</a></h3><p>Even if most of the tasks while developing can be done by directly running <code>cargo</code> commands, I start by setting up a <code>justfile</code>, that is used by <a href=https://github.com/casey/just>just</a>, an alternative to <code>make</code>.
Then <code>justfile</code> will provide a unified interface to run all the commands needed for development and also lists them conveniently.</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-make data-lang=make><span style=display:flex><span><span style=color:#89b4fa>build</span><span style=color:#89dceb;font-weight:700>:</span>
</span></span><span style=display:flex><span>  cargo build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89b4fa>run</span><span style=color:#89dceb;font-weight:700>:</span> build
</span></span><span style=display:flex><span>  zellij -l ./plugin-dev-workspace.kdl -s zjstatus-dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89b4fa>test</span><span style=color:#89dceb;font-weight:700>:</span>
</span></span><span style=display:flex><span>  cargo component <span style=color:#89dceb>test</span> -- --nocapture
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89b4fa>lint</span><span style=color:#89dceb;font-weight:700>:</span>
</span></span><span style=display:flex><span>  cargo clippy --all-targets -- -D warnings
</span></span><span style=display:flex><span>  cargo audit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89b4fa>release version</span><span style=color:#89dceb;font-weight:700>:</span>
</span></span><span style=display:flex><span>  cargo set-version <span style=color:#89dceb;font-weight:700>{{</span>version<span style=color:#89dceb;font-weight:700>}}</span>
</span></span><span style=display:flex><span>  direnv <span style=color:#89dceb>exec</span> . cargo build --release
</span></span><span style=display:flex><span>  git commit -am <span style=color:#a6e3a1>&#34;chore: bump version to v{{version}}&#34;</span>
</span></span><span style=display:flex><span>  git tag -m <span style=color:#a6e3a1>&#34;v{{version}}&#34;</span> v<span style=color:#89dceb;font-weight:700>{{</span>version<span style=color:#89dceb;font-weight:700>}}</span>
</span></span><span style=display:flex><span>  git cliff --current
</span></span></code></pre></td></tr></table></div></div><p>Commands can be run by calling <code>just &lt;command></code>, e.g. <code>just run</code>.
The syntax for releases allows to bump the version and create a git tag with a single command: <code>just release 0.1.0</code>.</p><h3 id=splitting-code-to-binary-and-library>Splitting code to binary and library<a hidden class=anchor aria-hidden=true href=#splitting-code-to-binary-and-library>#</a></h3><p>As we want to write tests and benchmarks for the code, we need to split the entrypoint of the plugin from the library code.
All parts that we want to test and benchmark need to be part of the library crate.
To split the binary from the library, we need to modify the file structure in the following way:</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>src/main.rs -&gt; src/bin/plugin-name.rs <span style=color:#6c7086;font-style:italic># move</span>
</span></span><span style=display:flex><span>src/lib.rs <span style=color:#6c7086;font-style:italic># create</span>
</span></span></code></pre></td></tr></table></div></div><p>The current main file will be moved to <code>src/bin/plugin.rs</code> and the <code>src/lib.rs</code> file will be created.
<code>src/lib.rs</code> will contain the library code, that contains logic for the plugin.
In addition to the directory structure, we need to modify the <code>Cargo.toml</code> file to reflect the changes:</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[[bin]]
</span></span><span style=display:flex><span>name = <span style=color:#a6e3a1>&#34;plugin-name&#34;</span>
</span></span><span style=display:flex><span>bench = <span style=color:#fab387>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[lib]
</span></span><span style=display:flex><span>bench = <span style=color:#fab387>false</span>
</span></span></code></pre></td></tr></table></div></div><p>This will prevent cargo from directly running library or binary code, when only benchmarks should be run.
It is important to configure the project like that because zellij&rsquo;s API with <code>register_plugin</code> will try to connect to the running zellij instance, which is not present when running benchmarks.
Since all logic related code is now located in the library, we need to import it in the binary or benchmarks with <code>use plugin_name::*;</code>.</p><h2 id=unit-testing>Unit testing<a hidden class=anchor aria-hidden=true href=#unit-testing>#</a></h2><p>For ensuring the correctness of plugin logic and to validate, that the logic works as expected when refactoring the code, I am a big fan of unit testing.
It not only helps to ensure correctness, but also provides a way to document the code and its usage.
In addition it helps to develop new features in a test driven way, such that the test is written before the actual implementation.</p><p>Unit tests in zellij plugins can be written by adding a <code>#[cfg(test)]</code> attribute to the test module and writing tests with the <code>#[test]</code> attribute - like in any other rust project.
You just need to make sure, that code that interacts with zellij&rsquo;s API is not executed when running tests, as it will fail otherwise.
This can be done by using the <code>#[cfg(not(test))]</code> attribute on the code that should not be executed when running tests.</p><p>Another tricky part is to run the unit tests, as they need to be run within a WebAssembly runtime (like <code>wasmtime</code>).
To simplify running the tests, I added <a href=https://github.com/bytecodealliance/cargo-component>cargo-component</a> to the project dependencies, which runs code with <code>wasmtime</code> after it has been compiled.
A shortcut for running the tests was also added to the <code>justfile</code> before.</p><p>Here&rsquo;s an example of a unit test, that verifies the correctness of the <code>parse_color</code> function:</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>mod</span> <span style=color:#fab387>test</span> {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>use</span> <span style=color:#cba6f7>super</span>::<span style=color:#89dceb;font-weight:700>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>fn</span> <span style=color:#89b4fa>test_parse_color</span>() {
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> result <span style=color:#89dceb;font-weight:700>=</span> parse_color(<span style=color:#a6e3a1>&#34;#010203&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> expected <span style=color:#89dceb;font-weight:700>=</span> RgbColor(<span style=color:#fab387>1</span>, <span style=color:#fab387>2</span>, <span style=color:#fab387>3</span>);
</span></span><span style=display:flex><span>        <span style=color:#89b4fa>assert_eq!</span>(result, <span style=color:#89dceb>Some</span>(expected.into()));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> result <span style=color:#89dceb;font-weight:700>=</span> parse_color(<span style=color:#a6e3a1>&#34;255&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> expected <span style=color:#89dceb;font-weight:700>=</span> Ansi256Color(<span style=color:#fab387>255</span>);
</span></span><span style=display:flex><span>        <span style=color:#89b4fa>assert_eq!</span>(result, <span style=color:#89dceb>Some</span>(expected.into()));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> result <span style=color:#89dceb;font-weight:700>=</span> parse_color(<span style=color:#a6e3a1>&#34;365&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#89b4fa>assert_eq!</span>(result, <span style=color:#89dceb>None</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> result <span style=color:#89dceb;font-weight:700>=</span> parse_color(<span style=color:#a6e3a1>&#34;#365&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#89b4fa>assert_eq!</span>(result, <span style=color:#89dceb>None</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=benchmarks>Benchmarks<a hidden class=anchor aria-hidden=true href=#benchmarks>#</a></h2><p>Benchmarks can be used to check for performance regressions when refactoring code.
They can also be used to measure the performance impact of new features.
Therefore it is important to store results of the benchmarks, to compare them with future runs.</p><p>Normally, I like to use <a href=https://github.com/nvzqz/divan>divan</a> for writing benchmarks, but it does not support WebAssembly yet.
Therefore I switched to <a href=https://github.com/bheisler/criterion.rs>criterion</a> since it supports WebAssembly and provides some convenient features for storing and comparing benchmark results.</p><p>To start with benchmarks, first add <code>criterion</code> and the benchmark targets to the <code>Cargo.toml</code> file:</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[dev-dependencies]
</span></span><span style=display:flex><span>criterion = { version = <span style=color:#a6e3a1>&#34;0.5.1&#34;</span>, default-features = <span style=color:#fab387>false</span>, features = [<span style=color:#a6e3a1>&#34;html_reports&#34;</span>] }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[bench]]
</span></span><span style=display:flex><span>name = <span style=color:#a6e3a1>&#34;benches&#34;</span>
</span></span><span style=display:flex><span>harness = <span style=color:#fab387>false</span>
</span></span></code></pre></td></tr></table></div></div><p>Benchmark targets must be named like the benchmark files in the benches directory, e.g. <code>benches/benches.rs</code>.</p><p>Follow the <a href=https://bheisler.github.io/criterion.rs/book/criterion_rs.html>criterion documentation</a> for writing benchmarks.
Here&rsquo;s a quick example:</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#cba6f7>use</span> criterion::{criterion_group, criterion_main, Criterion};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>use</span> zjstatus::render::formatted_parts_from_string_cached;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>fn</span> <span style=color:#89b4fa>bench_formattedparts_from_format_string_cached</span>(c: <span style=color:#cba6f7>&amp;</span><span style=color:#f9e2af>mut</span> Criterion) {
</span></span><span style=display:flex><span>    c.bench_function(<span style=color:#a6e3a1>&#34;formatted_parts_from_string_cached&#34;</span>, <span style=color:#89dceb;font-weight:700>|</span>b<span style=color:#89dceb;font-weight:700>|</span> {
</span></span><span style=display:flex><span>        b.iter(<span style=color:#89dceb;font-weight:700>||</span> {
</span></span><span style=display:flex><span>            formatted_parts_from_string_cached(
</span></span><span style=display:flex><span>                <span style=color:#a6e3a1>&#34;#[fg=#9399B2,bg=#181825,bold,italic] {index} {name} [] #[fg=#9399B2,bg=#181825,bold,italic] {index} {name} [] &#34;</span>,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>fn</span> <span style=color:#89b4fa>criterion_benchmark</span>(c: <span style=color:#cba6f7>&amp;</span><span style=color:#f9e2af>mut</span> Criterion) {
</span></span><span style=display:flex><span>    bench_formattedparts_from_format_string_cached(c);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89b4fa>criterion_group!</span>(benches, criterion_benchmark);
</span></span><span style=display:flex><span><span style=color:#89b4fa>criterion_main!</span>(benches);
</span></span></code></pre></td></tr></table></div></div><p>Similar to unit tests we need to make sure that code which interacts with zellij&rsquo;s API is not executed when running benchmarks.
Therefore we need to add a new feature to the <code>Cargo.toml</code> and add the <code>#[cfg(not(feature = "bench"))]</code> attribute to the code that should not be executed when running benchmarks.</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[features]
</span></span><span style=display:flex><span>bench = []
</span></span></code></pre></td></tr></table></div></div><p>Since criterion needs to store benchmark results in the <code>target</code> directory, we cannot run benchmarks with <code>cargo component bench</code>.
<code>cargo component bench</code> will not only try to run the plugin wasm binary outside of zellij, but also runs the benchmarks in <code>wasmtime</code> without granting permissions to write to the <code>target</code> directory.
Therefore we need to compile benchmarks with <code>cargo bench --target wasm32-wasi --benches --no-run --feature=benches</code>.
After compilation it will print the path to the compiled binaries.
These binaries then must be executed with <code>wasmtime</code> and the <code>--dir</code> flag to grant permissions to write to the <code>target</code> directory.
The following target in the <code>justfile</code> will automate this process:</p><div class=highlight><div style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f849c">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-make data-lang=make><span style=display:flex><span><span style=color:#89b4fa>bench</span><span style=color:#89dceb;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>#!/usr/bin/env bash</span>
</span></span><span style=display:flex><span>  <span style=color:#f5e0dc>benchmarks</span><span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;</span><span style=color:#cba6f7>$(</span>cargo bench --target wasm32-wasi --features<span style=color:#89dceb;font-weight:700>=</span>bench --no-run --color<span style=color:#89dceb;font-weight:700>=</span>always 2&gt;&amp;<span style=color:#fab387>1</span> | tee /dev/tty | grep -oP <span style=color:#a6e3a1>&#39;target/.*.wasm&#39;</span><span style=color:#cba6f7>)</span><span style=color:#a6e3a1>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#89dceb>echo</span> <span style=color:#a6e3a1>&#34;</span><span style=color:#f5e0dc>$benchmarks</span><span style=color:#a6e3a1>&#34;</span> <span style=color:#89b4fa>\
</span></span></span><span style=display:flex><span><span style=color:#89b4fa></span>    | xargs -I<span style=color:#89dceb;font-weight:700>{}</span> wasmtime --dir <span style=color:#f5e0dc>$PWD</span>/target::target <span style=color:#89dceb;font-weight:700>{}</span> --bench --color<span style=color:#89dceb;font-weight:700>=</span>always
</span></span></code></pre></td></tr></table></div></div><p>Since the benchmarks are now able to store the json results in the <code>target</code> directory, <code>criterion</code> is able to compare the result with previous runs.</p><p><img loading=lazy src=/img/learnings-from-developing-a-zellij-plugin/bench.png alt="example of benchmark output"></p><p>This technique allowed me to improve the performance of zjstatus a lot, after I learned how to better utilize the borrow checker and be aware of memory allocations.
To improve performance, I tried to avoid <code>.clone()</code> calls where possible and instead use references, since references are cheap to copy, whereas <code>.clone()</code> needs to allocate memory of the size of the cloned object and copy the data.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.nerd.rocks/tags/zellij/>zellij</a></li><li><a href=https://blog.nerd.rocks/tags/rust/>rust</a></li><li><a href=https://blog.nerd.rocks/tags/tdd/>tdd</a></li><li><a href=https://blog.nerd.rocks/tags/benchmarks/>benchmarks</a></li></ul><nav class=paginav><a class=prev href=https://blog.nerd.rocks/posts/getting-started-with-zellij-plugins/><span class=title>Â« Prev</span><br><span>Getting started with developing Zellij plugins</span></a>
<a class=next href=https://blog.nerd.rocks/posts/state-of-samesite-in-firefox-and-chrome/><span class=title>Next Â»</span><br><span>State of SameSite cookies in Firefox and Chromium</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.nerd.rocks>blog.nerd.rocks</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>